- name: Configure mpeg-dash player
  hosts: client
  become: yes

  tasks:
    - name: Update apt package cache
      apt:
        update_cache: yes

    - name: Install Necessary Packages
      apt:
        pkg: 
          - git
          - nodejs
          - npm
          - xauth
          - x11-utils
          - libx11-6
          - libxext6
          - libxrender1
          - libxfixes3
          - libxi6
          - libxtst6
          - chromium
        state: present

    - name: Clone Mpegdash Player Repo
      ansible.builtin.git:
        repo: "https://github.com/leandrocalmeida/player-mpegdash"
        dest: "/home/vagrant/player-mpegdash"
        version: "main"  # branch, tag ou commit
        clone: yes
        update: no  # não faz pull se já existir
        force: no

    - name: Install Player Dependencies
      command: "npm install"
      args:
        chdir: "/home/vagrant/player-mpegdash"

    - name: Configure SSH to enable X11 forwarding
      ansible.builtin.lineinfile:
        path: "/etc/ssh/sshd_config"
        regexp: '^#X11UseLocalhost*'
        line: 'X11UseLocalhost yes'

    - name: Configure SSH DisplayOffset
      ansible.builtin.lineinfile:
        path: "/etc/ssh/sshd_config"
        regexp: '^#X11DisplayOffset*'
        line: 'X11DisplayOffset 10'

    - name: Configure player to use virtual server
      ansible.builtin.lineinfile:
        path: "/home/vagrant/player-mpegdash/index.html"
        regexp: '^        url = "https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd";'
        line: '        url = "http://192.168.56.102/videos/worldcup2002-mp4.mpd";'

    - name: Configure player to use chromium browser by default
      ansible.builtin.lineinfile:
        path: "/home/vagrant/player-mpegdash/index.js"
        regexp: "^      '/usr/bin/google-chrome',"
        line: "      '/usr/bin/chromium',"

    - name: Configure player to use time passed through extra vars
      ansible.builtin.lineinfile:
        path: "/home/vagrant/player-mpegdash/index.js"
        regexp: '^  const videoDuration*'
        line: '  const videoDuration = {{ duration }} * 1000;'
